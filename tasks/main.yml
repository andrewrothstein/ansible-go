---
- name: get version of go if installed
  command: /usr/local/go/bin/go version
  register: installed_go_ver
  ignore_errors: true
  changed_when: false

- name: remove existing go installation to upgrade
  file:
    path: /usr/local/go
    state: absent
  when: installed_go_ver.rc == 0 and go_ver not in installed_go_ver.stdout
  
- name: download go archive...
  become: yes
  become_user: root
  get_url: >
    url={{go_tgz_url}}
    dest=/tmp/{{go_tgz}}
    mode=0644

- name: create go version directory
  become: yes
  become_user: root
  file: >-
    path=/usr/local/{{go_name}}
    state=directory
    
- name: unarchive go...
  become: yes
  become_user: root
  unarchive: >
    copy=no
    src=/tmp/{{go_tgz}}
    dest=/usr/local/{{go_name}}
    creates=/usr/local/{{go_name}}/go

- name: link in latest go
  become: yes
  become_user: root
  file: >-
    src=/usr/local/{{go_name}}/go
    dest=/usr/local/go
    state=link
    
- name: set go environment variables
  become: yes
  become_user: root
  with_items:
    - etc/profile.d/go.sh
  template: >
    src={{item}}.j2
    dest=/{{item}}
    mode=0644
